[{"id":"0102ef3a5e2d0b80","type":"tab","label":"フロー 1","disabled":false,"info":"","env":[]},{"id":"3a131ea1e5162895","type":"ui_text_input","z":"0102ef3a5e2d0b80","name":"Nhập số đèn","label":"         Số đèn (1–70)","tooltip":"Nhập đèn cần bật ( 1 giờ - 1 đèn)","group":"64f87c4c5bbe24b1","order":1,"width":6,"height":2,"passthru":true,"mode":"number","delay":0,"topic":"","sendOnBlur":true,"className":"","topicType":"str","x":90,"y":160,"wires":[["bf5915a08168e2a3"]]},{"id":"bf5915a08168e2a3","type":"change","z":"0102ef3a5e2d0b80","name":"Lưu vào flow","rules":[{"t":"set","p":"device_num","pt":"flow","to":"payload","tot":"msg"}],"x":300,"y":160,"wires":[[]]},{"id":"754f1d0e8bcf2afc","type":"ui_button","z":"0102ef3a5e2d0b80","name":"Gửi MQTT","group":"64f87c4c5bbe24b1","order":3,"width":6,"height":1,"passthru":false,"label":"Bật đèn","tooltip":"","color":"","bgcolor":"","className":"","icon":"send","payload":"","payloadType":"str","topic":"","topicType":"str","x":100,"y":220,"wires":[["f935775ed080d07f"]]},{"id":"f935775ed080d07f","type":"function","z":"0102ef3a5e2d0b80","name":"Tạo JSON","func":"let device = flow.get(\"device_num\") || 1;\nlet hour = flow.get(\"hour_val\") || 1;\n\nmsg.payload = {\n    device: device,\n    Hour: hour\n};\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":220,"wires":[["264e3eaf7d3387fb","f3d362cf0ee94c6b"]]},{"id":"264e3eaf7d3387fb","type":"mqtt out","z":"0102ef3a5e2d0b80","name":"set","topic":"APP_ON21146282","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"37fcf5bfccf8b220","x":470,"y":220,"wires":[]},{"id":"f3d362cf0ee94c6b","type":"change","z":"0102ef3a5e2d0b80","name":"Set redirect","rules":[{"t":"set","p":"payload","pt":"msg","to":"redirect","tot":"str"}],"x":490,"y":120,"wires":[["8328c4585a6615b3","859e78070239e0a8"]]},{"id":"8328c4585a6615b3","type":"delay","z":"0102ef3a5e2d0b80","name":"Delay xóa redirect","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"","randomLast":"","randomUnits":"seconds","allowrate":false,"outputs":1,"x":710,"y":180,"wires":[["81828e7d59c7cb14"]]},{"id":"81828e7d59c7cb14","type":"change","z":"0102ef3a5e2d0b80","name":"Xóa redirect","rules":[{"t":"set","p":"payload","pt":"msg","to":"idle","tot":"str"}],"x":650,"y":260,"wires":[["859e78070239e0a8"]]},{"id":"87fb5db113288ca4","type":"ui_text_input","z":"0102ef3a5e2d0b80","name":"Nhập số đèn","label":"         Số đèn (1–70)","tooltip":"Nhập đèn cần tắt","group":"52f90358f8dfb04c","order":1,"width":6,"height":2,"passthru":true,"mode":"number","delay":0,"topic":"","sendOnBlur":true,"className":"","topicType":"str","x":90,"y":420,"wires":[["88bded7ab1e4d086"]]},{"id":"88bded7ab1e4d086","type":"change","z":"0102ef3a5e2d0b80","name":"Lưu vào flow","rules":[{"t":"set","p":"device_num","pt":"flow","to":"payload","tot":"msg"}],"x":300,"y":420,"wires":[[]]},{"id":"43df198fa0c91c2c","type":"ui_button","z":"0102ef3a5e2d0b80","name":"Gửi MQTT","group":"52f90358f8dfb04c","order":3,"width":6,"height":1,"passthru":false,"label":"Tắt đèn","tooltip":"","color":"","bgcolor":"","className":"","icon":"send","payload":"","payloadType":"str","topic":"","topicType":"str","x":100,"y":480,"wires":[["33a239dfc08366be"]]},{"id":"33a239dfc08366be","type":"function","z":"0102ef3a5e2d0b80","name":"Tạo JSON","func":"let device = flow.get(\"device_num\") || 1;\n\n\nmsg.payload = {\n    device: device,\n    trigger: true\n};\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":480,"wires":[["2cb41f97b973076a","3c772691460aaf1d"]]},{"id":"2cb41f97b973076a","type":"mqtt out","z":"0102ef3a5e2d0b80","name":"OFF_GUEST","topic":"APP_OFF21146282","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"37fcf5bfccf8b220","x":500,"y":480,"wires":[]},{"id":"3c772691460aaf1d","type":"change","z":"0102ef3a5e2d0b80","name":"Set redirect","rules":[{"t":"set","p":"payload","pt":"msg","to":"redirect","tot":"str"}],"x":490,"y":380,"wires":[["859e78070239e0a8","58020ad59dc677c2"]]},{"id":"859e78070239e0a8","type":"ui_template","z":"0102ef3a5e2d0b80","group":"52f90358f8dfb04c","name":"Thông báo & Chuyển trang","order":3,"width":0,"height":0,"format":"<div style=\"text-align:center; font-size:20px; color:green;\">\n    <p id=\"success-msg\" style=\"display:none;\">✅ Điều khiển Thành công! </p>\n</div>\n\n<script>\n(function(scope) {\n    scope.$watch('msg.payload', function(payload) {\n        if (payload === 'redirect') {\n            document.getElementById('success-msg').style.display = 'block';\n            setTimeout(() => {\n                window.location.href = \"https://cisat.hcmute.edu.vn/\";\n            }, 3000);\n        } else {\n            document.getElementById('success-msg').style.display = 'none';\n        }\n    });\n})(scope);\n</script>","storeOutMessages":false,"fwdInMessages":false,"resendOnRefresh":false,"templateScope":"local","className":"","x":900,"y":340,"wires":[[]]},{"id":"58020ad59dc677c2","type":"delay","z":"0102ef3a5e2d0b80","name":"Delay xóa redirect","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"","randomLast":"","randomUnits":"seconds","allowrate":false,"outputs":1,"x":710,"y":440,"wires":[["8470cac33ee8c7e2"]]},{"id":"8470cac33ee8c7e2","type":"change","z":"0102ef3a5e2d0b80","name":"Xóa redirect","rules":[{"t":"set","p":"payload","pt":"msg","to":"idle","tot":"str"}],"x":670,"y":520,"wires":[["859e78070239e0a8"]]},{"id":"64f87c4c5bbe24b1","type":"ui_group","name":"Nhập đèn cần bật (1 đèn/ 1 giờ)","tab":"dashboard_tab","order":1,"disp":true,"width":"6","collapse":false,"className":""},{"id":"37fcf5bfccf8b220","type":"mqtt-broker","name":"APP","broker":"broker.hivemq.com","port":"1883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"52f90358f8dfb04c","type":"ui_group","name":"Nhập đèn cần tắt","tab":"dashboard_tab","order":2,"disp":true,"width":"6","collapse":false,"className":""},{"id":"dashboard_tab","type":"ui_tab","name":"Điều khiển đèn","icon":"dashboard","order":1,"disabled":false,"hidden":false}]
